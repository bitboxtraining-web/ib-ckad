# üìù TP Kubernetes ‚Äî ServiceAccount & RBAC

## Objectif
- Cr√©er un **ServiceAccount**  
- D√©finir un **Role** avec lecture des Pods  
- Attacher le Role au ServiceAccount via un **RoleBinding**  
- Tester les permissions depuis un Pod utilisant ce ServiceAccount

---

## 1Ô∏è‚É£ Cr√©er le ServiceAccount `app-sa`

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-sa
  namespace: default
``` 
```bash
kubectl apply -f sa.yaml
```
‚úÖ Ce ServiceAccount sera utilis√© par notre Pod.

2Ô∏è‚É£ Cr√©er le Role pod-reader
Permissions : lire les Pods (get, list, watch)

Namespace : default

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
```
```bash
kubectl apply -f role.yaml
```
3Ô∏è‚É£ Cr√©er le RoleBinding
Lien entre ServiceAccount app-sa et Role pod-reader

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-reader-binding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: app-sa
    namespace: default
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```
```bash
kubectl apply -f bind.yaml
```
4Ô∏è‚É£ Cr√©er un Pod utilisant le ServiceAccount
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-app
  namespace: default
spec:
  serviceAccountName: app-sa
  containers:
    - name: curl
      image: curlimages/curl
      command: ["sleep", "3600"]
```
```bash
kubectl apply -f test.yaml
```
5Ô∏è‚É£ Tester depuis le Pod
5.1 Entrer dans le Pod
```bash
kubectl exec -it test-app -- sh
```
5.2 Lister les Pods (lecture autoris√©e)
```bash
TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)

curl -k -H "Authorization: Bearer $TOKEN" https://kubernetes.default.svc/api/v1/pods
```
‚úÖ La liste des pods s‚Äôaffiche.

5.3 Supprimer un Pod (interdit)
```bash
curl -X DELETE -k -H "Authorization: Bearer $TOKEN" https://kubernetes.default.svc/api/v1/namespaces/default/pods/test-app
```
‚ùå R√©sultat attendu : Forbidden
Le ServiceAccount ne peut pas supprimer de Pod.

6Ô∏è‚É£ R√©sum√©
√âl√©ment	R√¥le
ServiceAccount	Qui ? Identit√© machine utilis√©e par un Pod (app-sa)
Role	Quoi ? Permissions limit√©es aux actions de lecture des Pods (pod-reader)
RoleBinding	Lien : attribue le Role au ServiceAccount (pod-reader-binding)
Test	Lecture autoris√©e, suppression interdite
